// DO NOT EDIT: generated by github.com/tim-online/go-afas-profit-rest/generate

package afas

import (
	"encoding/json"

	"github.com/cockroachdb/apd"
    "github.com/aodin/date"
    "github.com/cydev/zero"
)

{{range .Objects}}

// {{.Comment}}
type {{.Name}} struct {
    {{range .Fields}} {{.Name}} {{.Type}} {{if .Tags}}`{{.Tags}}`{{end}} // {{.Comment}}
    {{end}}
}

func ({{.Variable}} {{.Name}}) MarshalJSON() ([]byte, error) {
    // If struct is empty: do nothing
    if zero.IsZero({{.Variable}}) {
        return []byte("null"), nil
    }

	type alias {{.Name}}

	// type to json
	b, err := json.Marshal(alias({{.Variable}}))
	if err != nil {
		return b, err
	}

	// json to map with preservation of json struct tags
	m := map[string]interface{}{}
	json.Unmarshal(b, &m)

	jsonFields := {{.Variable}}.JSONFields()
	fields := map[string]interface{}{}
	jsonObjects := {{.Variable}}.JSONObjects()
	objects := map[string]interface{}{}
	for k, v := range m {
		for _, f := range jsonFields {
			if k == f {
				// value is a field
				fields[k] = v
			}
		}

		for _, f := range jsonObjects {
			if k == f {
                // skip empty objects
                // @TODO: move this logic to an Objects struct aliasing
                // map[string]interface{}
				if v == nil || zero.IsZero(v) {
					continue
				}

				// value is an object and not zero
				objects[k] = v
			}
		}
	}

	type Element struct {
		DBID    string                 `json:"@DbId,omitempty"`
		Fields  map[string]interface{} `json:"Fields,omitempty"`
		Objects map[string]interface{} `json:"Objects,omitempty"`
	}

	type Elements struct {
        Element []Element `json:"Element"`
    }

	structure := Elements{
        []Element{
            Element{
                {{- if .DBIDField}}
                DBID:    {{.Variable}}.DBID(),
                {{- end}}
                Fields:  fields,
                Objects: objects,
            },
        },
	}

	return json.Marshal(structure)
}

{{- if .DBIDField}}
func (k {{.Name}}) DBIDField() string {
	return "{{.DBIDField}}"
}

func (k {{.Name}}) DBID() string {
	return {{.Variable}}.{{.DBIDField}}
}
{{- end}}

func (k {{.Name}}) JSONFields() []string {
	return []string{
        {{range .Fields}}"{{.JSONName}}",
        {{end}}
	}
}

func (k {{.Name}}) JSONObjects() []string {
	return []string{
        {{range .Objects}}"{{.}}",
        {{end}}
	}
}
{{end}}

// vim: ft=gotexttmpl
